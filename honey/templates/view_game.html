{% extends "base.html" %}
{% from "macros.html" import render_field %}
{% from "macros.html" import render_date_time %}
{% from "macros.html" import render_user_link %}
{% from "macros.html" import form_has_errors %}
{% from "game_specific.html" import render_game_edit_form_fields %}

{% block head %}
  {{ super() }}
  <script src="/static/js/jquery.timers.js" type="text/javascript"></script>
  <script src="/static/js/bootstrap-button.js" type="text/javascript"></script>
  <!-- select engine based on the game type -->
  {% if game.type == "go" %}
  <script src="/static/js/go.js?now={{ "%H%M%S"|now }}" type="text/javascript"></script>
  {% elif game.type == "hex" %}
    <script src="/static/js/hex.js?now={{ "%H%M%S"|now }}" type="text/javascript"></script>
  {% else %}
    <!-- TODO This should not happen. -->
  {% endif %}
  <script src="/static/js/honey.js?now={{ "%H%M%S"|now }}" type="text/javascript"></script>
  <script src="/static/js/ui.js?now={{ "%H%M%S"|now }}" type="text/javascript"></script>
  <script src="/static/js/ga.js" type="text/javascript"></script>
  <script type="text/javascript">
    _bridge = new Bridge({{game.nodes|tojson|safe}}, {{comment_paths|tojson|safe}}, {{init_path|tojson|safe}}, new UIHandler());
    // Post click handler
    $(function() {
      $("#post_comment form input[value='Post']").click(function(e) {
        $("#post_comment form input[name='short_path_json']").attr("value", JSON.stringify(_bridge.getCurrNodeShortPath()));
        $("#post_comment form input[name='full_path_json']").attr("value", JSON.stringify(_bridge.getCurrNodeFullPath()));
      });
      $("#edit_game_toggle").click(function(e) {
        e.preventDefault();
        $("#edit_game").toggle();
      });
      $("#post_comment_toggle").click(function(e) {
        e.preventDefault();
        $("#post_comment").toggle();
      });
      $("#commit_toggle").click(function(e) {
        e.preventDefault();
        $.ajax({
          type: "POST",
          url: "{{url_for('post_update', game_id=game._id)}}",
          data: {"update_data": JSON.stringify(_bridge.getNodes())}
        }).done(function(reply) {
          if("err" in reply && reply.err) {
            alert(reply["err"]);
          }
          // now the game is in sync with the server again
          _bridge.syncGame();
        });
      });
      // toggle forms that have errors
      {% if comment_form|form_has_errors() %}
        $("#post_comment_toggle").click();
      {% endif %}
      {% if game_edit_form and game_edit_form|form_has_errors() %}
        $("#edit_game_toggle").click();
      {% endif %}
    });
  </script>
{% endblock %}

{% block raw_content %}
<div class="row" style="margin-top: 20px;">
  <div class="span6">
    <div id='board'></div>
  </div>
  <div class="span6">
    {% include "game_info.html" %}
    <p>
      {% if game_edit_form %}
      <a id="edit_game_toggle" href="" data-toggle="button" class="btn">
        <i class="icon-cog"></i>
        edit game
      </a>
      {% endif %}
      {% if session.username %}
      <a id="post_comment_toggle" data-toggle="button" class="btn">
        <i class="icon-comment"></i>
        comment
      </a>
      {% endif %}
      <a id="commit_toggle" href="" data-toggle="button" class="btn" style="display:none"
        title="Commit changes you made to the server.">
        <i class="icon-refresh"></i>
        commit
      </a>
    </p>
    {% if game_edit_form %}
    <div id="edit_game" style="display: none;">
        <form method="post" action="{{ url_for('edit_game', game_id=game._id) }}">
          {{ render_game_edit_form_fields(game, game_edit_form) }}
        <p><input type=submit value=Post></p>
       </form>
    </div>
    {% endif %}
    {% if session.username %}
    <div id="post_comment" style="display: none;">
        <form method="post" action="{{ url_for('post_comment', game_id=game._id) }}">
          {{ comment_form.short_path_json(value=null) }}
          {{ comment_form.full_path_json(value=null) }}
          {{ render_field(comment_form.comment, rows=3, cols=90) }}
          <p><input type=submit value=Post></p>
       </form>
    </div>
    {% endif %}
    <div id="comments">
      {% for comment in comments %}
      <p>
        <div class="comment" id="comment_{{comment._id}}">
          <div> <strong>Posted by {{ render_user_link(comment.user.username) }} on {{ comment.date.strftime("%Y-%m-%d %H:%M:%S")}}:</strong></div>
          {{ comment.text }}
        </div>
      </p>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

